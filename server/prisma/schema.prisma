generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
    id         String    @id @default(cuid())
    username   String    @unique
    email      String    @unique
    password   String
    phone      String?   @unique
    firstName  String    @map("first_name")
    lastName   String?   @map("last_name")
    avatarUrl  String?   @map("avatar_url")
    isOnline   Boolean   @default(false) @map("is_online")
    lastSeenAt DateTime? @map("last_seen_at")
    createdAt  DateTime  @default(now()) @map("created_at")
    updatedAt  DateTime  @updatedAt @map("updated_at")

    isVerified               Boolean   @default(false) @map("is_verified")
    verificationToken        String?   @map("verification_token")
    verificationTokenExpires DateTime?

    tokens Token[]

    messages          Message[]
    messageReactions  MessageReaction[]
    messagesRead      MessageRead[]
    forwardedMessages Message[]         @relation("ForwardedMessages")

    chatMembers ChatMember[]

    chatsWhereIsAdmin Chat[]   @relation("ChatWhereIsAdmin")
    folders           Folder[]

    contacts  Contact[] @relation("UserContacts")
    contactOf Contact[] @relation("ContactUser")

    deletedMessages DeletedMessage[]
    deletedChats    DeletedChat[]

    @@map("users")
}

model Token {
    id           String   @id @default(cuid())
    refreshToken String   @unique
    expiresIn    DateTime
    userId       String
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("tokens")
}

model Contact {
    id        String   @id @default(cuid())
    userId    String
    contactId String
    nickname  String?
    isBlocked Boolean  @default(false) @map("is_blocked")
    createdAt DateTime @default(now()) @map("created_at")

    user    User @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
    contact User @relation("ContactUser", fields: [contactId], references: [id], onDelete: Cascade)

    @@unique([userId, contactId])
    @@index([userId])
    @@index([contactId])
    @@map("contacts")
}

model Chat {
    id          String       @id @default(cuid())
    name        String?
    description String?
    avatar      String?
    uniqueLink  String?      @unique @map("unique_link")
    type        ChatType     @default(PRIVATE)
    isActive    Boolean      @default(true)
    isDeleted   Boolean      @default(false)
    deletedAt   DateTime?
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt
    adminId     String?
    admin       User?        @relation("ChatWhereIsAdmin", fields: [adminId], references: [id])
    members     ChatMember[]
    messages    Message[]

    pinnedMessageId String?  @map("pinned_message_id")
    pinnedMessage   Message? @relation("PinnedMessage", fields: [pinnedMessageId], references: [id])

    folders FolderChat[]

    deletedChats DeletedChat[]

    @@map("chats")
}

model DeletedChat {
    id        String   @id @default(cuid())
    userId    String
    chatId    String
    deletedAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

    @@unique([userId, chatId])
    @@map("deleted_chats")
}

model Folder {
    id        String   @id @default(cuid())
    name      String
    icon      String?
    order     Int      @default(0)
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    userId String
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

    chats FolderChat[]

    @@map("folders")
}

model FolderChat {
    id       String   @id @default(cuid())
    chatId   String
    folderId String
    addedAt  DateTime @default(now())

    chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
    folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)

    @@unique([chatId, folderId])
    @@map("folder_chats")
}

model ChatMember {
    id         String     @id @default(cuid())
    userId     String
    chatId     String
    role       MemberRole @default(MEMBER)
    joinedAt   DateTime   @default(now())
    lastReadAt DateTime   @default(now())

    isMuted     Boolean   @default(false) @map("is_muted")
    muteUntil   DateTime? @map("mute_until")
    pinnedOrder Int?      @map("pinned_order")
    isArchived  Boolean   @default(false) @map("is_archived")
    leftAt      DateTime? @map("left_at")

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)

    @@unique([userId, chatId])
    @@map("chat_members")
}

model Message {
    id         String      @id @default(cuid())
    content    String
    type       MessageType @default(TEXT)
    systemData Json?
    replyToId  String?
    replyTo    Message?    @relation("MessageReply", fields: [replyToId], references: [id])
    replies    Message[]   @relation("MessageReply")
    editedAt   DateTime?
    isRevoked  Boolean     @default(false) @map("is_revoked")
    createdAt  DateTime    @default(now())
    updatedAt  DateTime    @updatedAt

    senderId String?
    sender   User?   @relation(fields: [senderId], references: [id])

    chatId String
    chat   Chat   @relation(fields: [chatId], references: [id], onDelete: Cascade)

    forwardedFromId String? @map("forwarded_from_id")
    forwardedFrom   User?   @relation("ForwardedMessages", fields: [forwardedFromId], references: [id])

    pinnedInChats Chat[] @relation("PinnedMessage")

    attachments     Attachment[]
    reactions       MessageReaction[]
    messagesRead    MessageRead[]
    deletedMessages DeletedMessage[]

    @@index([chatId])
    @@index([chatId, createdAt])
    @@index([chatId, isRevoked])
    @@index([senderId])
    @@map("messages")
}

model DeletedMessage {
    id        String   @id @default(cuid())
    userId    String
    messageId String
    deletedAt DateTime @default(now())

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@unique([userId, messageId])
    @@map("deleted_messages")
}

model Attachment {
    id        String  @id @default(cuid())
    url       String
    fileName  String?
    fileSize  Int?
    mimetype  String?
    messageId String
    message   Message @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@index([messageId])
    @@map("attachments")
}

model MessageReaction {
    id        String   @id @default(cuid())
    emoji     String
    createdAt DateTime @default(now())
    userId    String
    messageId String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@unique([userId, messageId, emoji])
    @@index([messageId])
    @@map("message_reactions")
}

model MessageRead {
    id        String   @id @default(cuid())
    userId    String
    messageId String
    readAt    DateTime @default(now())
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

    @@unique([userId, messageId])
    @@index([messageId])
    @@map("message_reads")
}

enum ChatType {
    PRIVATE
    GROUP
    CHANNEL
}

enum MemberRole {
    OWNER
    ADMIN
    MEMBER
}

enum MessageType {
    TEXT
    IMAGE
    FILE
    VOICE
    VIDEO
    SYSTEM
}
